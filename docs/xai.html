<!DOCTYPE html>

<html>
<head>
  <title>xai.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>xai.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <!-- vim: set syntax=lua ts=2 sw=2 et : -->
<p><img style="padding:3px;" src="https://raw.githubusercontent.com/timm/tested/main/etc/img/script.png" align=left width=135></p>
<p style="text-align: right;">
 <a 
  href="https://zenodo.org/badge/latestdoi/569981645"> <img 
   src="https://zenodo.org/badge/569981645.svg" alt="DOI"></a><br>
<img src="https://img.shields.io/badge/task-ai-purple"> <img 
 src="https://img.shields.io/badge/language-lua5.4-orange"><br><img 
 src="https://img.shields.io/badge/purpose-teaching-yellow">
<a href="https://github.com/timm/tested/actions/workflows/tests.yml"><br><img 
  src="https://github.com/timm/tested/actions/workflows/tests.yml/badge.svg"></a>
 <br>
<a href="https://github.com/timm/tested/blob/main/src/xai.lua">download</a> <br>
<a href="https://github.com/timm/tested/blob/main/etc/data/auto93.csv">example data</a> <br>
<a href="#license">license</a> <br>
<a href="https://github.com/timm/tested/issues">issues</a><br clear=all>

<p style="text-align: left;">
This code supports multi-goal semi-supervised explanation.  Here,  optimization 
is treated as a kind of data mining; i.e.  we recursively bi-cluster (using the 
distance to two remote points), all the while pruning the  “worst” half of the 
data (as measured by a multi-goal domination predicate).
During this, we  only label one or two points per cluster. Afterwards, 
the rules we generate to explain the better rows is generated from the delta between best cluster and the rest.</p>
For help with code, see comments at the <a href="#about">end of this file</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> is,help = {}, <span class="hljs-string">[[
  
xai: multi-goal semi-supervised explanation
(c) 2023 Tim Menzies &lt;timm@ieee.org&gt; BSD-2
  
USAGE: lua xai.lua [OPTIONS] [-g ACTIONS]
  
OPTIONS:
  -b  --bins    initial number of bins       = 16
  -c  --cliffs  cliff's delta threshold      = .147
  -d  --d       different is over sd*d       = .35
  -f  --file    data file                    = ../etc/data/auto93.csv
  -F  --Far     distance to distant          = .95
  -g  --go      start-up action              = nothing
  -h  --help    show help                    = false
  -H  --Halves  search space for clustering  = 512
  -m  --min     size of smallest cluster     = .5
  -M  --Max     numbers                      = 512
  -p  --p       dist coefficient             = 2
  -r  --rest    how many of rest to sample   = 4
  -R  --Reuse   child splits reuse a parent pole = true
  -s  --seed    random number seed           = 937162211
]]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="tricks">Tricks</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Magic regex trick to match keys and values from <code>help</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> magic = <span class="hljs-string">"\n[%s]+[-][%S][%s]+[-][-]([%S]+)[^\n]+= ([%S]+)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Trick for finding rogue names,  escaped into the global space.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> b4={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> b4[k]=v <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Trick that lets us define everything in any order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> adds,add,any,at,better,bin,bins
<span class="hljs-keyword">local</span> contrast,copy,cli,csv,cells,cliffsDelta,coerce
<span class="hljs-keyword">local</span> diffs,dist,div,eg,extend,fmt,gt,half,has,go,itself
<span class="hljs-keyword">local</span> kap,keys,<span class="hljs-built_in">lines</span>,locals,lt,main,many,map,merge,merged,merges,mid
<span class="hljs-keyword">local</span> no,norm,o,oo,per,push,rint,rand,rnd,row,rogues
<span class="hljs-keyword">local</span> say,sayln,Seed,selects,showTree,showRule,<span class="hljs-built_in">sort</span>,slice,stats,sway,tree,value
<span class="hljs-keyword">local</span> COL,COLS,DATA,NUM,RANGE,RULE,SYM</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Trick to  shorten call to maths functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> m = <span class="hljs-built_in">math</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="-a-name-create-creation-a-"><a name=create>Creation</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create a <code>NUM</code> or a <code>SYM</code>. Column
names are a little language that<br>e.g. makes <code>NUM</code>s if name starts in upper case; or
e.g. makes goals if the name ends with
the maximize (<code>+</code>) or minimize (<code>-</code>) or klass (<code>!</code>) symbol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COL</span><span class="hljs-params">(n,s,    col)</span></span>
   col = s:<span class="hljs-built_in">find</span><span class="hljs-string">"^[A-Z]"</span> <span class="hljs-keyword">and</span> NUM(n,s) <span class="hljs-keyword">or</span> SYM(n,s) 
   col.isIgnored  = col.txt:<span class="hljs-built_in">find</span><span class="hljs-string">"X$"</span>
   col.isKlass    = col.txt:<span class="hljs-built_in">find</span><span class="hljs-string">"!$"</span>
   col.isGoal     = col.txt:<span class="hljs-built_in">find</span><span class="hljs-string">"[!+-]$"</span>
   <span class="hljs-keyword">return</span> col <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Create a <code>NUM</code> to summarize a stream of numbers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM</span><span class="hljs-params">(n,s)</span></span> 
  <span class="hljs-keyword">return</span> {at= n <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>, txt= s <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>, n=<span class="hljs-number">0</span>,
          hi= -m.<span class="hljs-built_in">huge</span>, lo= m.<span class="hljs-built_in">huge</span>, 
          ok=<span class="hljs-literal">true</span>, has={},
          w= (s <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>):<span class="hljs-built_in">find</span><span class="hljs-string">"-$"</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Create a <code>SYM</code> to summarize a stream of symbols.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM</span><span class="hljs-params">(n,s)</span></span>
  <span class="hljs-keyword">return</span> {at=n <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>, txt=s <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>, n=<span class="hljs-number">0</span>, 
          mode=<span class="hljs-literal">nil</span>,  most=<span class="hljs-number">0</span>,
          isSym=<span class="hljs-literal">true</span>, has={}} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Create a set of <code>NUM</code>s or <code>SYM</code>s columns.
Once created, all cols are stored in <code>all</code>
while the non-skipped cols are also stored as
either <code>cols.x</code> independent input variables or
<code>cols.y</code> dependent goal variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS</span><span class="hljs-params">(ss,     col,cols)</span></span>
  cols={names=ss, all={},x={},y={}}
  <span class="hljs-keyword">for</span> n,s <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ss) <span class="hljs-keyword">do</span>  
    col = push(cols.all, COL(n,s))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> col.isIgnored <span class="hljs-keyword">and</span> col.isKlass <span class="hljs-keyword">then</span> cols.klass = col <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> col.isIgnored <span class="hljs-keyword">then</span> push(col.isGoal <span class="hljs-keyword">and</span> cols.y <span class="hljs-keyword">or</span> cols.x, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> cols <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Create a RANGE  that tracks the y dependent values seen in 
the range <code>lo</code> to <code>hi</code> some independent variable in column number <code>at</code> whose name is <code>txt</code>. 
Note that the way this is used (in the <code>bins</code> function, below)
for  symbolic columns, <code>lo</code> is always the same as <code>hi</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE</span><span class="hljs-params">(at,txt,lo,hi)</span></span> 
  <span class="hljs-keyword">return</span> {at=at,txt=txt,lo=lo,hi=lo <span class="hljs-keyword">or</span> hi <span class="hljs-keyword">or</span> lo,y=SYM()} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Create a  RULE that groups <code>ranges</code> by their column id. 
Each group is a disjunction of its contents (and
sets of groups are conjunctions).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RULE</span><span class="hljs-params">(ranges,      t)</span></span>
  t={}
  <span class="hljs-keyword">for</span> _,range <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ranges) <span class="hljs-keyword">do</span>
    t[range.txt] = t[range.txt] <span class="hljs-keyword">or</span> {}
    push(t[range.txt], range) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Create a <code>DATA</code> to contain <code>rows</code>, summarized in <code>cols</code>.
Optionally, is any <code>rows</code> are supplied, load those in.<br>Case [1]: <code>src</code> is a filename of a csv file
whose first row 
are the comma-separate names processed by <code>COLS</code> (above).
into a new <code>DATA</code>. Every other row is stored in the DATA by
calling the 
<code>row</code> function (defined below).<br>Case [2]: <code>src</code> is another data in which case we minic its
column structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DATA</span><span class="hljs-params">(src,  rows,     data,add)</span></span>
  data= {rows={},cols=<span class="hljs-literal">nil</span>} <span class="hljs-comment">-- initially, no cols</span>
  add = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> row(data,t) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">"string"</span> <span class="hljs-keyword">then</span> csv(src,add) <span class="hljs-keyword">else</span> data.cols=COLS(src.cols.names) <span class="hljs-keyword">end</span> 
  map(rows <span class="hljs-keyword">or</span> {}, add)
  <span class="hljs-keyword">return</span> data <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="update">Update</h2>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Update <code>data</code> with  row <code>t</code>. If <code>data.cols</code>
does not exist, the use <code>t</code> to create <code>data.cols</code>.
Otherwise, add <code>t</code> to <code>data.rows</code> and update the summaries in <code>data.cols</code>.
To avoid updating skipped columns, we only iterate
over <code>cols.x</code> and <code>cols.y</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">row</span><span class="hljs-params">(data,t)</span></span>
  <span class="hljs-keyword">if</span> data.cols  <span class="hljs-keyword">then</span>
    push(data.rows,t)
    <span class="hljs-keyword">for</span> _,cols <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{data.cols.x, data.cols.y} <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span> 
	     add(col, t[col.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">else</span> data.cols = COLS(t) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> data <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Update one COL with <code>x</code> (values from one cells of one row).
Used  by (e.g.) the <code>row</code> and <code>adds</code> function.
<code>SYM</code>s just increment a symbol counts.
<code>NUM</code>s store <code>x</code> in a finite sized cache. When it
fills to more than <code>is.Max</code>, then at probability 
<code>is.Max/col.n</code> replace any existing item
(selected at random). If anything is added, the list
may not longer be sorted so set <code>col.ok=false</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span><span class="hljs-params">(col,x,  n,       sym,num)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sym</span><span class="hljs-params">(t)</span></span> 
    t[x] = n + (t[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) 
    <span class="hljs-keyword">if</span> t[x] &gt; col.most <span class="hljs-keyword">then</span> col.most,col.mode = t[x],x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num</span><span class="hljs-params">(t)</span></span>
    col.lo, col.hi = m.<span class="hljs-built_in">min</span>(x,col.lo), m.<span class="hljs-built_in">max</span>(x,col.hi) 
    <span class="hljs-keyword">if</span>     #t &lt; is.Max           <span class="hljs-keyword">then</span> col.ok=<span class="hljs-literal">false</span>; t[#t + <span class="hljs-number">1</span>]=x 
    <span class="hljs-keyword">elseif</span> rand() &lt; is.Max/col.n <span class="hljs-keyword">then</span> col.ok=<span class="hljs-literal">false</span>; t[rint(<span class="hljs-number">1</span>, #t)]=x <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">------------ </span>
  <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">"?"</span> <span class="hljs-keyword">then</span>
    n = n <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    col.n = col.n + n
    <span class="hljs-keyword">if</span> col.isSym <span class="hljs-keyword">then</span> sym(col.has) <span class="hljs-keyword">else</span> num(col.has) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Update a COL with multiple items from <code>t</code>. This is useful when <code>col</code> is being
used outside of some DATA.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">adds</span><span class="hljs-params">(col,t)</span></span> 
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> add(col,x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> col <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Update a RANGE to cover <code>x</code> and <code>y</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extend</span><span class="hljs-params">(range,n,s)</span></span>
  range.lo = m.<span class="hljs-built_in">min</span>(n, range.lo)
  range.hi = m.<span class="hljs-built_in">max</span>(n, range.hi)
  add(range.y, s) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="query">Query</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>A query that returns contents of a column. If <code>col</code> is a <code>NUM</code> with
unsorted contents, then sort before return the contents.
Called by (e.g.) the <code>mid</code> and <code>div</code> functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span><span class="hljs-params">(col)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> col.isSym <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> col.ok <span class="hljs-keyword">then</span> <span class="hljs-built_in">sort</span>(col.has) <span class="hljs-keyword">end</span> 
  col.ok = <span class="hljs-literal">true</span> <span class="hljs-comment">-- the invariant here is that "has" is ready to be shared.</span>
  <span class="hljs-keyword">return</span> col.has <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>A query that  returns a <code>cols</code>‘s central tendency<br>(mode for <code>SYM</code>s and median for <code>NUM</code>s). Called by (e.g.) the <code>stats</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mid</span><span class="hljs-params">(col,    mode,most)</span></span>
  <span class="hljs-keyword">return</span> col.isSym <span class="hljs-keyword">and</span> col.mode <span class="hljs-keyword">or</span> per(has(col), <span class="hljs-number">.5</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>A query that returns a <code>col</code>‘s deviation from central tendency<br>(entropy for <code>SYM</code>s and standard deviation for <code>NUM</code>s)..</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">div</span><span class="hljs-params">(col,    e)</span></span>
  <span class="hljs-keyword">if</span>   col.isSym 
  <span class="hljs-keyword">then</span> e=<span class="hljs-number">0</span>
       <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(col.has) <span class="hljs-keyword">do</span> e= e-n/col.n*m.<span class="hljs-built_in">log</span>(n/col.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>
       <span class="hljs-keyword">return</span> e
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> (per(has(col),<span class="hljs-number">.9</span>) - per(has(col), <span class="hljs-number">.1</span>))/<span class="hljs-number">2.58</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>A query that returns <code>mid</code> or <code>div</code> of <code>cols</code> (defaults to <code>data.cols.y</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stats</span><span class="hljs-params">(data,  fun,cols,nPlaces,     tmp)</span></span>
  cols= cols <span class="hljs-keyword">or</span> data.cols.y
  tmp = kap(cols,
            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,col)</span></span> <span class="hljs-keyword">return</span> rnd((fun <span class="hljs-keyword">or</span> mid)(col),nPlaces), col.txt <span class="hljs-keyword">end</span>)
  tmp[<span class="hljs-string">"N"</span>] = #data.rows
  <span class="hljs-keyword">return</span> tmp,map(cols,mid)  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>A query that normalizes <code>n</code> 0..1. Called by (e.g.) the <code>dist</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">norm</span><span class="hljs-params">(num,n)</span></span>
  <span class="hljs-keyword">return</span> n==<span class="hljs-string">"?"</span> <span class="hljs-keyword">and</span> n <span class="hljs-keyword">or</span> (n - num.lo)/(num.hi - num.lo + <span class="hljs-number">1</span>/m.<span class="hljs-built_in">huge</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>A query that returns the score a distribution of symbols inside a SYM.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">value</span><span class="hljs-params">(has,  nB,nR,sGoal,    b,r)</span></span>
  sGoal,nB,nR = sGoal <span class="hljs-keyword">or</span> <span class="hljs-literal">true</span>, nB <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>, nR <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  b,r = <span class="hljs-number">0</span>,<span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(has) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> x==sGoal <span class="hljs-keyword">then</span> b = b + n <span class="hljs-keyword">else</span> r = r + n <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  b,r = b/(nB+<span class="hljs-number">1</span>/m.<span class="hljs-built_in">huge</span>), r/(nR+<span class="hljs-number">1</span>/m.<span class="hljs-built_in">huge</span>)
  <span class="hljs-keyword">return</span> b^<span class="hljs-number">2</span>/(b+r) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>A query that returns the distances 0..1 between rows <code>t1</code> and <code>t2</code>.<br>If any values are unknown, assume max distances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dist</span><span class="hljs-params">(data,t1,t2,  cols,    d,dist1,sym,num)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sym</span><span class="hljs-params">(x,y)</span></span> 
    <span class="hljs-keyword">return</span> x==y <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num</span><span class="hljs-params">(x,y)</span></span> 
    <span class="hljs-keyword">if</span> x==<span class="hljs-string">"?"</span> <span class="hljs-keyword">then</span> x= y&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>	
    <span class="hljs-keyword">if</span> y==<span class="hljs-string">"?"</span> <span class="hljs-keyword">then</span> y= x&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>	
    <span class="hljs-keyword">return</span> m.<span class="hljs-built_in">abs</span>(x-y) <span class="hljs-keyword">end</span> 
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dist1</span><span class="hljs-params">(col,x,y)</span></span>
    <span class="hljs-keyword">if</span> x==<span class="hljs-string">"?"</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">"?"</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> col.isSym <span class="hljs-keyword">and</span> sym(x,y) <span class="hljs-keyword">or</span> num(norm(col,x), norm(col,y)) 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-------------</span>
  d, cols = <span class="hljs-number">0</span>, (cols <span class="hljs-keyword">or</span> data.cols.x)	
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span>
    d = d + dist1(col, t1[col.at], t2[col.at])^is.p <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> (d/#cols)^(<span class="hljs-number">1</span>/is.p) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>A query that returns true if <code>row1</code> is better than another.
This is Zitzler’s indicator predicate that
judges the domination status 
of pair of individuals by running a “what-if” query. 
It checks what we lose if we (a) jump from one 
individual to another (see <code>s1</code>), or if we (b) jump the other way (see <code>s2</code>).
The jump that losses least indicates which is the best row.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">better</span><span class="hljs-params">(data,row1,row2,    s1,s2,ys,x,y)</span></span> 
  s1,s2,ys,x,y = <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,data.cols.y
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ys) <span class="hljs-keyword">do</span>
    x  = norm(col, row1[col.at] )
    y  = norm(col, row2[col.at] )
    s1 = s1 - m.<span class="hljs-built_in">exp</span>(col.w * (x-y)/#ys)
    s2 = s2 - m.<span class="hljs-built_in">exp</span>(col.w * (y-x)/#ys) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/#ys &lt; s2/#ys <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h2 id="clustering">Clustering</h2>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Cluster <code>rows</code> into two sets by
dividing the data via their distance to two remote points.
To speed up finding those remote points, only look at
<code>some</code> of the data. Also, to avoid outliers, only look
<code>is.Far=.95</code> (say) of the way across the space. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">half</span><span class="hljs-params">(data,  rows,cols,above)</span></span>
  <span class="hljs-keyword">local</span> left,right,far,gap,some,proj,<span class="hljs-built_in">cos</span>,tmp,A,B,c = {},{}
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gap</span><span class="hljs-params">(r1,r2)</span></span> <span class="hljs-keyword">return</span> dist(data, r1, r2, cols) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cos</span><span class="hljs-params">(a,b,c)</span></span> <span class="hljs-keyword">return</span> (a^<span class="hljs-number">2</span> + c^<span class="hljs-number">2</span> - b^<span class="hljs-number">2</span>)/(<span class="hljs-number">2</span>*c) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">proj</span><span class="hljs-params">(r)</span></span>    <span class="hljs-keyword">return</span> {row=r, x=<span class="hljs-built_in">cos</span>(gap(r,A), gap(r,B),c)} <span class="hljs-keyword">end</span>
  rows = rows <span class="hljs-keyword">or</span> data.rows
  some = many(rows,is.Halves)
  A    = (is.Reuse <span class="hljs-keyword">and</span> above) <span class="hljs-keyword">or</span> any(some)
  tmp  = <span class="hljs-built_in">sort</span>(map(some,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span> <span class="hljs-keyword">return</span> {row=r, d=gap(r,A)} <span class="hljs-keyword">end</span> ),lt<span class="hljs-string">"d"</span>)
  far  = tmp[(#tmp*is.Far)//<span class="hljs-number">1</span>]
  B,c  = far.row, far.d
  <span class="hljs-keyword">for</span> n,two <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(map(rows,proj),lt<span class="hljs-string">"x"</span>)) <span class="hljs-keyword">do</span>
    push(n &lt;= #rows/<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> left <span class="hljs-keyword">or</span> right, two.row) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> left,right,A,B,c <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Cluster, recursively, some <code>rows</code> by  dividing them in two, many times</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tree</span><span class="hljs-params">(data,  rows,cols,above,     here)</span></span>
  rows = rows <span class="hljs-keyword">or</span> data.rows
  here = {data=DATA(data,rows)}
  <span class="hljs-keyword">if</span> #rows &gt;= <span class="hljs-number">2</span>*(#data.rows)^is.<span class="hljs-built_in">min</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">local</span> left,right,A,B = half(data, rows, cols, above)
    here.left  = tree(data, left,  cols, A)
    here.right = tree(data, right, cols, B) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> here <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Cluster can be displayed by this function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showTree</span><span class="hljs-params">(tree,  lvl,post)</span></span>
  <span class="hljs-keyword">if</span> tree <span class="hljs-keyword">then</span> 
    lvl  = lvl <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
    <span class="hljs-built_in">io</span>.<span class="hljs-built_in">write</span>(fmt(<span class="hljs-string">"%s[%s] "</span>,(<span class="hljs-string">"|.. "</span>):<span class="hljs-built_in">rep</span>(lvl), #(tree.data.rows)))
    <span class="hljs-built_in">print</span>((lvl==<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> tree.left) <span class="hljs-keyword">and</span> o(stats(tree.data)) <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>)
    showTree(tree.left, lvl+<span class="hljs-number">1</span>)
    showTree(tree.right,lvl+<span class="hljs-number">1</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="optimization">Optimization</h2>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Recursively prune the worst half the data. Return
the survivors and some sample of the rest.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sway</span><span class="hljs-params">(data,     worker,best,rest)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">worker</span><span class="hljs-params">(rows,worse,  above)</span></span>
    <span class="hljs-keyword">if</span>   #rows &lt;= (#data.rows)^is.<span class="hljs-built_in">min</span> 
    <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> rows, many(worse, is.rest*#rows) 
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">local</span> l,r,A,B = half(data, rows, cols, above)
         <span class="hljs-keyword">if</span> better(data,B,A) <span class="hljs-keyword">then</span> l,r,A,B = r,l,B,A <span class="hljs-keyword">end</span>
         map(r, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> push(worse,row) <span class="hljs-keyword">end</span>) 
         <span class="hljs-keyword">return</span> worker(l,worse,A) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">----------------------------------</span>
  best,rest = worker(data.rows,{})
  <span class="hljs-keyword">return</span> DATA(data,best), DATA(data,rest) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="discretization">Discretization</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Return RANGEs that distinguish sets of rows (stored in <code>rowss</code>).
To reduce the search space,
values in <code>col</code> are mapped to small number of <code>bin</code>s.
For NUMs, that number is <code>is.bins=16</code> (say) (and after dividing
the column into, say, 16 bins, then we call <code>mergeAny</code> to see
how many of them can be combined with their neighboring bin).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bins</span><span class="hljs-params">(cols,rowss,      with1Col,withAllRows)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">with1Col</span><span class="hljs-params">(col,     n,ranges)</span></span>
    n,ranges = withAllRows(col)
    ranges   = <span class="hljs-built_in">sort</span>(map(ranges,itself),lt<span class="hljs-string">"lo"</span>) <span class="hljs-comment">-- keyArray to numArray, sorted</span>
    <span class="hljs-keyword">if</span>   col.isSym 
    <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> ranges 
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> merges(ranges, n/is.bins, is.d*div(col)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withAllRows</span><span class="hljs-params">(col,    n,ranges,xy)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xy</span><span class="hljs-params">(x,y,      k)</span></span>
      <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">"?"</span> <span class="hljs-keyword">then</span> 
        n = n + <span class="hljs-number">1</span>
        k = bin(col,x)
        ranges[k] = ranges[k] <span class="hljs-keyword">or</span> RANGE(col.at,col.txt,x)
        extend(ranges[k], x, y) <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">end</span> <span class="hljs-comment">-----------</span>
    n,ranges = <span class="hljs-number">0</span>,{}
    <span class="hljs-keyword">for</span> y,rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rowss) <span class="hljs-keyword">do</span> <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span> xy(row[col.at],y) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> n, ranges 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">--------------</span>
  <span class="hljs-keyword">return</span> map(cols, with1Col) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Map <code>x</code> into a small number of bins. <code>SYM</code>s just get mapped
to themselves but <code>NUM</code>s get mapped to one of <code>is.bins</code> values.
Called by function <code>bins</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bin</span><span class="hljs-params">(col,x,      tmp)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">"?"</span> <span class="hljs-keyword">or</span> col.isSym <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  tmp = (col.hi - col.lo)/(is.bins - <span class="hljs-number">1</span>)
  <span class="hljs-keyword">return</span> col.hi == col.lo <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> m.<span class="hljs-built_in">floor</span>(x/tmp + <span class="hljs-number">.5</span>)*tmp <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Given a sorted list of ranges, try fusing adjacent items
(stopping when no more fuse-ings can be found). When done,
make the ranges run from minus to plus infinity
(with no gaps in between).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merges</span><span class="hljs-params">(ranges0,nSmall,nFar,     noGaps,try2Merge)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noGaps</span><span class="hljs-params">(t)</span></span>
    <span class="hljs-keyword">for</span> j = <span class="hljs-number">2</span>,#t <span class="hljs-keyword">do</span> t[j].lo = t[j<span class="hljs-number">-1</span>].hi <span class="hljs-keyword">end</span>
    t[<span class="hljs-number">1</span>].lo  = -m.<span class="hljs-built_in">huge</span>
    t[#t].hi =  m.<span class="hljs-built_in">huge</span>
    <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">try2Merge</span><span class="hljs-params">(left,right,j,     y)</span></span>
    y = merged(left.y, right.y, nSmall, nFar)
    <span class="hljs-keyword">if</span> y <span class="hljs-keyword">then</span> 
      j = j+<span class="hljs-number">1</span> <span class="hljs-comment">-- next round, skip over right.</span>
      left.hi, left.y = right.hi, y <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">return</span> j , left 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-------------</span>
  <span class="hljs-keyword">local</span> ranges1,j,here = {},<span class="hljs-number">1</span>
  <span class="hljs-keyword">while</span> j &lt;= #ranges0 <span class="hljs-keyword">do</span>
    here = ranges0[j]
    <span class="hljs-keyword">if</span> j &lt; #ranges0 <span class="hljs-keyword">then</span> j,here = try2Merge(here, ranges0[j+<span class="hljs-number">1</span>], j) <span class="hljs-keyword">end</span> 
    j=j+<span class="hljs-number">1</span>
    push(ranges1,here) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> #ranges0==#ranges1 <span class="hljs-keyword">and</span> noGaps(ranges0) <span class="hljs-keyword">or</span> merges(ranges1,nSmall,nFar) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>If (1) the parts are too small or
(2) the whole is as good (or simpler) than the parts,
then return the merge.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merged</span><span class="hljs-params">(col1,col2,nSmall, nFar,  new)</span></span>
  new = merge(col1,col2)
  <span class="hljs-keyword">if</span> nSmall <span class="hljs-keyword">and</span> col1.n &lt; nSmall <span class="hljs-keyword">or</span> col2.n &lt; nSmall                     <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> new <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> nFar   <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> col1.isSym <span class="hljs-keyword">and</span> m.<span class="hljs-built_in">abs</span>(mid(col1) - mid(col2)) &lt; nFar <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> new <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> div(new) &lt;= (div(col1)*col1.n + div(col2)*col2.n)/new.n <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> new <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Merge two <code>cols</code>. Called by function <code>merged</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span><span class="hljs-params">(col1,col2,    new)</span></span>
  new = copy(col1)
  <span class="hljs-keyword">if</span>   col1.isSym 
  <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(col2.has) <span class="hljs-keyword">do</span> add(new,x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(col2.has) <span class="hljs-keyword">do</span> add(new,n)   <span class="hljs-keyword">end</span>
       new.lo = m.<span class="hljs-built_in">min</span>(col1.lo, col2.lo)
       new.hi = m.<span class="hljs-built_in">max</span>(col1.hi, col2.hi) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> new <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h2 id="contrast-sets">Contrast Sets</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">contrast</span><span class="hljs-params">(data)</span></span>
  <span class="hljs-keyword">local</span> best,rest = sway(data)
  <span class="hljs-keyword">local</span> all,v,pick = {}
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">v</span><span class="hljs-params">(has)</span></span> <span class="hljs-keyword">return</span> value(has, #best.rows, #rest.rows, <span class="hljs-string">"best"</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pick</span><span class="hljs-params">(t)</span></span>
    <span class="hljs-keyword">local</span> most,first,rule = <span class="hljs-number">-1</span>,t[<span class="hljs-number">1</span>].val
    <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,#t <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">if</span> t[i].val &gt; <span class="hljs-number">.05</span> <span class="hljs-keyword">and</span> t[i].val &gt; first/<span class="hljs-number">10</span> <span class="hljs-keyword">then</span> 
        <span class="hljs-keyword">local</span> ranges,one,tmp, bestr,restr
        ranges= map(slice(t,<span class="hljs-number">1</span>,i),at<span class="hljs-string">"range"</span>)
        one=    RULE(ranges)
        bestr= selects(one,best.rows)
        restr= selects(one,rest.rows)
        tmp=    v({best= #bestr, rest=#restr})
           <span class="hljs-built_in">print</span>(i,<span class="hljs-number">100</span>,tmp, o(showRule(one)))
        <span class="hljs-keyword">if</span> #bestr + #restr &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> tmp &gt; most <span class="hljs-keyword">then</span> 
           most,rule = tmp,one <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">return</span> rule,most
  <span class="hljs-keyword">end</span> <span class="hljs-comment">---------</span>
  <span class="hljs-keyword">for</span> _,ranges <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(bins(data.cols.x,{best=best.rows, rest=rest.rows})) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,range <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ranges) <span class="hljs-keyword">do</span>
      push(all, {range=range, val= v(range.y.has)})  <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> pick(<span class="hljs-built_in">sort</span>(all,gt<span class="hljs-string">"val"</span>)) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showRule</span><span class="hljs-params">(rule,      silly,show1,show,mergefinalize,merge)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">silly</span><span class="hljs-params">(t)</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> t[<span class="hljs-number">1</span>].lo  == -m.<span class="hljs-built_in">huge</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> t[#t].hi ==  m.<span class="hljs-built_in">huge</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> i=<span class="hljs-number">2</span>,#t <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> t[i].lo == t[i<span class="hljs-number">-1</span>].hi <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>  <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show1</span><span class="hljs-params">(range)</span></span> 
    <span class="hljs-keyword">return</span> range.lo==range.hi <span class="hljs-keyword">and</span> range.lo  <span class="hljs-keyword">or</span> {lo=range.lo, hi=range.hi} <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">(t)</span></span>
    <span class="hljs-keyword">return</span> map(t, show1)  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>if not silly(t) then return map(t, show1)  end end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span><span class="hljs-params">(t0)</span></span>
    <span class="hljs-keyword">local</span> j,t,left,right = <span class="hljs-number">1</span>,{}
    <span class="hljs-keyword">while</span> j &lt;= #t0 <span class="hljs-keyword">do</span>
      left, right = t0[j], t0[j+<span class="hljs-number">1</span>]
      <span class="hljs-keyword">if</span> right <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">print</span>(left.txt,left.hi,right.lo,right.hi)
        <span class="hljs-keyword">if</span> left.hi==right.lo <span class="hljs-keyword">then</span> left.hi=right.hi; j=j+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span>  <span class="hljs-keyword">end</span>
      push(t,left)
      j = j + <span class="hljs-number">1</span> 
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> #t0 == #t <span class="hljs-keyword">and</span> t0 <span class="hljs-keyword">or</span> merge(t) 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-----------------------------------------</span>
  <span class="hljs-keyword">return</span> kap(rule, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attr,t)</span></span> <span class="hljs-keyword">return</span> show(merge(<span class="hljs-built_in">sort</span>(t,lt<span class="hljs-string">"lo"</span>))),attr <span class="hljs-keyword">end</span>) 
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">selects</span><span class="hljs-params">(rule,rows,    oneOfThem,allOfThem)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">oneOfThem</span><span class="hljs-params">(ranges,row,    x)</span></span> 
    <span class="hljs-keyword">for</span> _,range <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ranges) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">local</span> lo, hi, at = range.lo, range.hi, range.at
      x = row[at]
      <span class="hljs-keyword">if</span> x == <span class="hljs-string">"?"</span>         <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">if</span> lo==hi <span class="hljs-keyword">and</span> lo==x <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">if</span> lo&lt;=x  <span class="hljs-keyword">and</span> x&lt; hi <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allOfThem</span><span class="hljs-params">(row)</span></span>
    <span class="hljs-keyword">for</span> _,ranges <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rule) <span class="hljs-keyword">do</span> 
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> oneOfThem(ranges,row) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> map(rows, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span> <span class="hljs-keyword">if</span> allOfThem(r) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> r <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h2 id="miscellaneous-support-code">Miscellaneous Support Code</h2>
<h3 id="meta">Meta</h3>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Return self</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">itself</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h3 id="maths">Maths</h3>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Round numbers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnd</span><span class="hljs-params">(n, nPlaces)</span></span> 
  <span class="hljs-keyword">local</span> mult = <span class="hljs-number">10</span>^(nPlaces <span class="hljs-keyword">or</span> <span class="hljs-number">2</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(n * mult + <span class="hljs-number">0.5</span>) / mult <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Random number generation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Seed=<span class="hljs-number">937162211</span> <span class="hljs-comment">-- seed</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rint</span><span class="hljs-params">(nlo,nhi)</span></span>  <span class="hljs-comment">-- random ints  </span>
  <span class="hljs-keyword">return</span> m.<span class="hljs-built_in">floor</span>(<span class="hljs-number">0.5</span> + rand(nlo,nhi)) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rand</span><span class="hljs-params">(nlo,nhi)</span></span> <span class="hljs-comment">-- random floats</span>
  nlo, nhi = nlo <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>, nhi <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  Seed = (<span class="hljs-number">16807</span> * Seed) % <span class="hljs-number">2147483647</span>
  <span class="hljs-keyword">return</span> nlo + (nhi-nlo) * Seed / <span class="hljs-number">2147483647</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Non-parametric effect-size test
 M.Hess, J.Kromrey. 
 Robust Confidence Intervals for Effect Sizes: 
 A Comparative Study of Cohen’s d and Cliff’s Delta Under Non-normality and Heterogeneous Variances
 American Educational Research Association, San Diego, April 12 - 16, 2004<br> 0.147=  small, 0.33 =  medium, 0.474 = large; med –&gt; small at .2385</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cliffsDelta</span><span class="hljs-params">(ns1,ns2)</span></span> 
  <span class="hljs-keyword">if</span> #ns1 &gt; <span class="hljs-number">256</span>     <span class="hljs-keyword">then</span> ns1 = many(ns1,<span class="hljs-number">256</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> #ns2 &gt; <span class="hljs-number">256</span>     <span class="hljs-keyword">then</span> ns2 = many(ns2,<span class="hljs-number">256</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> #ns1 &gt; <span class="hljs-number">10</span>*#ns2 <span class="hljs-keyword">then</span> ns1 = many(ns1,<span class="hljs-number">10</span>*#ns2) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> #ns2 &gt; <span class="hljs-number">10</span>*#ns1 <span class="hljs-keyword">then</span> ns2 = many(ns2,<span class="hljs-number">10</span>*#ns1) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> n,gt,lt = <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ns1) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,y <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ns2) <span class="hljs-keyword">do</span>
      n = n + <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> x &gt; y <span class="hljs-keyword">then</span> gt = gt + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">if</span> x &lt; y <span class="hljs-keyword">then</span> lt = lt + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> m.<span class="hljs-built_in">abs</span>(lt - gt)/n &gt; is.cliffs <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Given two tables with the same keys, report if their
values are different.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">diffs</span><span class="hljs-params">(nums1,nums2)</span></span>
  <span class="hljs-keyword">return</span> kap(nums1, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,nums)</span></span> 
              <span class="hljs-keyword">return</span> cliffsDelta(nums.has,nums2[k].has),nums.txt <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h3 id="string-to-thing">String to thing</h3>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Coerce string to boolean, int,float or (failing all else) strings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">coerce</span><span class="hljs-params">(s,    fun)</span></span> 
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fun</span><span class="hljs-params">(s1)</span></span>
    <span class="hljs-keyword">if</span> s1==<span class="hljs-string">"true"</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">elseif</span> s1==<span class="hljs-string">"false"</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> s1 <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.tointeger(s) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(s) <span class="hljs-keyword">or</span> fun(s:<span class="hljs-built_in">match</span><span class="hljs-string">"^%s*(.-)%s*$"</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Split a string <code>s</code>  on commas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cells</span><span class="hljs-params">(s,    t)</span></span>
  t={}; <span class="hljs-keyword">for</span> s1 <span class="hljs-keyword">in</span> s:<span class="hljs-built_in">gmatch</span>(<span class="hljs-string">"([^,]+)"</span>) <span class="hljs-keyword">do</span> t[<span class="hljs-number">1</span>+#t] = coerce(s1) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Run <code>fun</code> for all lines in a file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lines</span><span class="hljs-params">(sFilename,fun,    src,s)</span></span> 
  src = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(sFilename)
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">do</span>
    s = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>(); <span class="hljs-keyword">if</span> s <span class="hljs-keyword">then</span> fun(s) <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(src) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Run <code>fun</code> on the cells  in each row of a csv file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(sFilename,fun)</span></span>
  <span class="hljs-built_in">lines</span>(sFilename, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span></span> fun(cells(line)) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h3 id="lists">Lists</h3>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Push an item <code>x</code> onto  a list.<br>Return a list, sorted on <code>fun</code>.<br>Return a function sorting down on field <code>x</code>.<br>Return a function sorting up on field <code>x</code>.<br>Return one item at random.<br>Return many items, selected at random.<br>Map a function on  table (results in items 1,2,3…)    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>push = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t,x)</span></span> t[#t+<span class="hljs-number">1</span>]=x; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-built_in">sort</span> = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t,f)</span></span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
at   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> t[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
lt   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[x] &lt; b[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
gt   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[x] &gt; b[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
any  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span>   <span class="hljs-keyword">return</span> t[rint(#t)] <span class="hljs-keyword">end</span>
many = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t,n,    u)</span></span> u={}; <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,n <span class="hljs-keyword">do</span> push(u, any(t)) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span> 
map  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, fun)</span></span> <span class="hljs-keyword">return</span> kap(t, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,v)</span></span> <span class="hljs-keyword">return</span> fun(v) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>
keys = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(kap(t,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,_)</span></span> <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span>)) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Map a function on table (results in items key1,key2,…)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">kap</span><span class="hljs-params">(t, fun,     u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> v,k=fun(k,v); u[k <span class="hljs-keyword">or</span> (<span class="hljs-number">1</span>+#u)]=v; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Return the <code>p</code>-ratio item in <code>t</code>; e.g. <code>per(t,.5)</code> returns the medium.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">per</span><span class="hljs-params">(t,p)</span></span> 
  p=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(((p <span class="hljs-keyword">or</span> <span class="hljs-number">.5</span>)*#t)+<span class="hljs-number">.5</span>); <span class="hljs-keyword">return</span> t[m.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>,m.<span class="hljs-built_in">min</span>(#t,p))] <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Deep copy of a table <code>t</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span><span class="hljs-params">(t,    u)</span></span> 
  <span class="hljs-keyword">if</span>  <span class="hljs-built_in">type</span>(t)~=<span class="hljs-string">"table"</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[k] = copy(v) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Return a portion of <code>t</code>; go,stop,inc defaults to 1,#t,1.
Negative indexes are supported.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">slice</span><span class="hljs-params">(t, go, stop, inc,    u)</span></span> 
  <span class="hljs-keyword">if</span> go   <span class="hljs-keyword">and</span> go   &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> go=#t+go     <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> stop <span class="hljs-keyword">and</span> stop &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> stop=#t+stop <span class="hljs-keyword">end</span>
  u={}
  <span class="hljs-keyword">for</span> j=(go <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)//<span class="hljs-number">1</span>,(stop <span class="hljs-keyword">or</span> #t)//<span class="hljs-number">1</span>,(inc <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)//<span class="hljs-number">1</span> <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=t[j] <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h3 id="strings">Strings</h3>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p><code>fmt</code> means <code>string.format</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fmt  = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>print to standard error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">say</span><span class="hljs-params">(...)</span></span>   <span class="hljs-built_in">io</span>.<span class="hljs-built_in">stderr</span>:<span class="hljs-built_in">write</span>(fmt(...)) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sayln</span><span class="hljs-params">(...)</span></span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">stderr</span>:<span class="hljs-built_in">write</span>(fmt(...)..<span class="hljs-string">"\n"</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Print a nested table (sorted by the keys of the table).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">oo</span><span class="hljs-params">(t)</span></span> <span class="hljs-built_in">print</span>(o(t)); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o</span><span class="hljs-params">(t,    fun)</span></span> 
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t)~=<span class="hljs-string">"table"</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(t) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fun</span> <span class="hljs-params">(k,v)</span></span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">":%s %s"</span>,k,o(v)) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> <span class="hljs-string">"{"</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(#t&gt;<span class="hljs-number">0</span>  <span class="hljs-keyword">and</span> map(t,o) <span class="hljs-keyword">or</span> <span class="hljs-built_in">sort</span>(kap(t,fun)),<span class="hljs-string">" "</span>)..<span class="hljs-string">"}"</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <h3 id="main-control">Main Control</h3>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Rune all the functions whose name matches
the command-line flag <code>-g xx</code>. Show the help
string if the <code>-h</code> flag is set. Return to the operating
system the number of failing <code>funs</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span><span class="hljs-params">(funs,is,help,    y,n,saved,k,val,ok)</span></span>
  y,n,saved = <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,copy(is)
  <span class="hljs-keyword">if</span>   is.help 
  <span class="hljs-keyword">then</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(<span class="hljs-built_in">print</span>(help)) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> _,pair <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(funs) <span class="hljs-keyword">do</span>
    k = pair.key
    <span class="hljs-keyword">if</span> k:<span class="hljs-built_in">find</span>(<span class="hljs-string">".*"</span>..is.go..<span class="hljs-string">".*"</span>) <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(saved) <span class="hljs-keyword">do</span> is[k]=v <span class="hljs-keyword">end</span>
      Seed = is.seed
      <span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(Seed)
      <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">"\n▶️  %s %s"</span>,k,(<span class="hljs-string">"-"</span>):<span class="hljs-built_in">rep</span>(<span class="hljs-number">60</span>)))
      ok,val = <span class="hljs-built_in">pcall</span>(pair.fun)
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok         <span class="hljs-keyword">then</span> n=n+<span class="hljs-number">1</span>; sayln(<span class="hljs-string">"❌ FAIL %s %s"</span>,k,val); 
                                    sayln(<span class="hljs-built_in">debug</span>.<span class="hljs-built_in">traceback</span>()) 
      <span class="hljs-keyword">elseif</span> val==<span class="hljs-literal">false</span> <span class="hljs-keyword">then</span> n=n+<span class="hljs-number">1</span>; sayln(<span class="hljs-string">"❌ FAIL %s"</span>,k)
      <span class="hljs-keyword">else</span>                   y=y+<span class="hljs-number">1</span>; sayln(<span class="hljs-string">"✅ PASS %s"</span>,k) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> y+n&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> sayln(<span class="hljs-string">"\n🔆 %s\n"</span>,o({pass=y, fail=n, success=<span class="hljs-number">100</span>*y/(y+n)//<span class="hljs-number">1</span>})) <span class="hljs-keyword">end</span>
  rogues()
  <span class="hljs-keyword">return</span> fails <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Return any rogue locals (i.e. all those we did not
trap in the <code>b4</code> list at top of file).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rogues</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">"#W ?%s %s"</span>,k,<span class="hljs-built_in">type</span>(v))) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Update <code>t</code> using command-line options. For boolean
flags, just flip the default values. For others, read
the new value from the command line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cli</span><span class="hljs-params">(t)</span></span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span>
    v = <span class="hljs-built_in">tostring</span>(v)
    <span class="hljs-keyword">for</span> n,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">if</span> x==<span class="hljs-string">"-"</span>..(k:<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)) <span class="hljs-keyword">or</span> x==<span class="hljs-string">"--"</span>..k <span class="hljs-keyword">then</span>
        v= v==<span class="hljs-string">"false"</span> <span class="hljs-keyword">and</span> <span class="hljs-string">"true"</span> <span class="hljs-keyword">or</span> v==<span class="hljs-string">"true"</span> <span class="hljs-keyword">and</span> <span class="hljs-string">"false"</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
    t[k] = coerce(v) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h2 id="-a-name-egs-examples-a-"><a name=egs>Examples</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Place to store examples.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> egs = {}
help = help .. <span class="hljs-string">"\nACTIONS:\n"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Used <code>go</code> to define an example</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go</span><span class="hljs-params">(key,xplain,fun)</span></span>
  help =  help ..fmt(<span class="hljs-string">"  -g  %s\t%s\n"</span>,key,xplain)
  egs[<span class="hljs-number">1</span>+#egs] = {key=key,fun=fun} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Disable an example by renaming it <code>no</code>. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">no</span><span class="hljs-params">(_,__,___)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>

go(<span class="hljs-string">"Is"</span>,<span class="hljs-string">"show options"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span> oo(is) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"rand"</span>,<span class="hljs-string">"demo random number generation"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(     t,u)</span></span>
  Seed=<span class="hljs-number">1</span>; t={}; <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">1000</span> <span class="hljs-keyword">do</span> push(t,rint(<span class="hljs-number">100</span>)) <span class="hljs-keyword">end</span>
  Seed=<span class="hljs-number">1</span>; u={}; <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">1000</span> <span class="hljs-keyword">do</span> push(u,rint(<span class="hljs-number">100</span>)) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-built_in">assert</span>(v==u[k]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"some"</span>,<span class="hljs-string">"demo of reservoir sampling"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(     num1)</span></span>
  is.Max = <span class="hljs-number">32</span>
  num1 = NUM()
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">10000</span> <span class="hljs-keyword">do</span> add(num1,i) <span class="hljs-keyword">end</span>
  oo(has(num1)) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"nums"</span>,<span class="hljs-string">"demo of NUM"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(     num1,num2)</span></span>
  num1,num2 = NUM(), NUM()
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">10000</span> <span class="hljs-keyword">do</span> add(num1, rand()) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">10000</span> <span class="hljs-keyword">do</span> add(num2, rand()^<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>,rnd(mid(num1)), rnd(div(num1)))
  <span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>,rnd(mid(num2)), rnd(div(num2))) 
  <span class="hljs-keyword">return</span> <span class="hljs-number">.5</span> == rnd(mid(num1)) <span class="hljs-keyword">and</span> mid(num1)&gt; mid(num2) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"syms"</span>,<span class="hljs-string">"demo SYMS"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(    sym)</span></span>
  sym=adds(SYM(), {<span class="hljs-string">"a"</span>,<span class="hljs-string">"a"</span>,<span class="hljs-string">"a"</span>,<span class="hljs-string">"a"</span>,<span class="hljs-string">"b"</span>,<span class="hljs-string">"b"</span>,<span class="hljs-string">"c"</span>})
  <span class="hljs-built_in">print</span> (mid(sym), rnd(div(sym))) 
  <span class="hljs-keyword">return</span> <span class="hljs-number">1.38</span> == rnd(div(sym)) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"csv"</span>,<span class="hljs-string">"reading csv files"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(     n)</span></span>
  n=<span class="hljs-number">0</span>; csv(is.file, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> n=n+#t <span class="hljs-keyword">end</span>) 
  <span class="hljs-keyword">return</span> <span class="hljs-number">3192</span> == n <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"data"</span>, <span class="hljs-string">"showing data sets"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(    data,col)</span></span> 
  data=DATA(is.file)
  col=data.cols.x[<span class="hljs-number">1</span>]
  <span class="hljs-built_in">print</span>(col.lo,col.hi, mid(col),div(col))
  oo(stats(data)) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"clone"</span>,<span class="hljs-string">"replicate structure of a DATA"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(    data1,data2)</span></span>
  data1=DATA(is.file)
  data2=DATA(data1,data1.rows) 
  oo(stats(data1))
  oo(stats(data2)) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"cliffs"</span>,<span class="hljs-string">"stats tests"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(   t1,t2,t3)</span></span>
  <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span> == cliffsDelta( {<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">3</span>},{<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">3</span>}),<span class="hljs-string">"1"</span>)
  <span class="hljs-built_in">assert</span>(<span class="hljs-literal">true</span>  == cliffsDelta( {<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">3</span>}, {<span class="hljs-number">9</span>,<span class="hljs-number">9</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">10</span>,<span class="hljs-number">9</span>,<span class="hljs-number">6</span>}),<span class="hljs-string">"2"</span>) 
  t1,t2={},{}
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">1000</span> <span class="hljs-keyword">do</span> push(t1,rand()) <span class="hljs-keyword">end</span> <span class="hljs-comment">--rand()/10) end</span>
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">1000</span> <span class="hljs-keyword">do</span> push(t2,rand()^<span class="hljs-number">.5</span>) <span class="hljs-keyword">end</span> <span class="hljs-comment">--rand()*10) end</span>
  <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span> == cliffsDelta(t1,t1),<span class="hljs-string">"3"</span>) 
  <span class="hljs-built_in">assert</span>(<span class="hljs-literal">true</span>  == cliffsDelta(t1,t2),<span class="hljs-string">"4"</span>) 
  <span class="hljs-keyword">local</span> diff,j=<span class="hljs-literal">false</span>,<span class="hljs-number">1.0</span>
  <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> diff  <span class="hljs-keyword">do</span>
    t3=map(t1,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x*j <span class="hljs-keyword">end</span>)
    diff=cliffsDelta(t1,t3)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"&gt;"</span>,rnd(j),diff) 
    j=j*<span class="hljs-number">1.025</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"dist"</span>,<span class="hljs-string">"distance test"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(    data,num)</span></span>
  data = DATA(is.file)
  num  = NUM()
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(data.rows) <span class="hljs-keyword">do</span>
    add(num,dist(data, row, data.rows[<span class="hljs-number">1</span>])) <span class="hljs-keyword">end</span>
  oo{lo=num.lo, hi=num.hi, mid=rnd(mid(num)), div=rnd(div(num))} <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"half"</span>,<span class="hljs-string">"divide data in halg"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(   data,l,r)</span></span>
  data = DATA(is.file)
  <span class="hljs-keyword">local</span> left,right,A,B,c = half(data) 
  <span class="hljs-built_in">print</span>(#left,#right)
  l,r = DATA(data,left), DATA(data,right)
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"l"</span>,o(stats(l)))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"r"</span>,o(stats(r))) <span class="hljs-keyword">end</span>)
 
go(<span class="hljs-string">"tree"</span>,<span class="hljs-string">"make snd show tree of clusters"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(   data,l,r)</span></span>
  showTree(tree(DATA(is.file))) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"sway"</span>,<span class="hljs-string">"optimizing"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(    data,best,rest)</span></span>
  data = DATA(is.file)
  best,rest = sway(data)
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nall "</span>, o(stats(data))) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"    "</span>,   o(stats(data,div))) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nbest"</span>, o(stats(best))) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"    "</span>,   o(stats(best,div))) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nrest"</span>, o(stats(rest))) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"    "</span>,   o(stats(rest,div))) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nall ~= best?"</span>, o(diffs(best.cols.y, data.cols.y)))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"best ~= rest?"</span>, o(diffs(best.cols.y, rest.cols.y))) <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"bins"</span>, <span class="hljs-string">"find deltas between best and rest"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(    data,best,rest, b4)</span></span>
  data = DATA(is.file)
  best,rest = sway(data)
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"all"</span>,<span class="hljs-string">""</span>,<span class="hljs-string">""</span>,<span class="hljs-string">""</span>,o{best=#best.rows, rest=#rest.rows})
  <span class="hljs-keyword">for</span> k,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(bins(data.cols.x,{best=best.rows, rest=rest.rows})) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,range <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">if</span> range.txt ~= b4 <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span><span class="hljs-string">""</span> <span class="hljs-keyword">end</span>
      b4 = range.txt
      <span class="hljs-built_in">print</span>(range.txt,range.lo,range.hi,
           rnd(value(range.y.has, #best.rows,#rest.rows,<span class="hljs-string">"best"</span>)), 
           o(range.y.has)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>)

go(<span class="hljs-string">"contrast"</span>,<span class="hljs-string">"explore contrast sets"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(     rule,most)</span></span>
  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)
  rule,most= contrast(DATA(is.file)) 
  <span class="hljs-built_in">print</span>(most,o(rule)) <span class="hljs-keyword">end</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <h2 id="start-up">Start-up</h2>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p> Parse the <code>help</code> string to make the <code>the</code> config variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>help:<span class="hljs-built_in">gsub</span>(magic, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span></span> is[k] = coerce(v) <span class="hljs-keyword">end</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>If not being loaded by other file, then return whatever <code>main</code> returns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>   <span class="hljs-keyword">not</span> <span class="hljs-built_in">pcall</span>(<span class="hljs-built_in">debug</span>.<span class="hljs-built_in">getlocal</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>) 
<span class="hljs-keyword">then</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>( main(egs, cli(is), help) ) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Else, bundle the locals (so the other file can use them), and return them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> _locals,_i={},<span class="hljs-number">1</span> 
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">local</span> _name, _value = <span class="hljs-built_in">debug</span>.<span class="hljs-built_in">getlocal</span>(<span class="hljs-number">1</span>, _i)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _name <span class="hljs-keyword">then</span> <span class="hljs-keyword">break</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> _name:<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) ~= <span class="hljs-string">"_"</span> <span class="hljs-keyword">then</span> _locals[_name]=_value <span class="hljs-keyword">end</span>
  _i = _i + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
<span class="hljs-keyword">return</span> _locals</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <h2 id="-a-name-about-about-this-code-a-"><a name=about>About this code</a></h2>
<p style="text-align: left;">
The aim here was to achieve as much functionality in as few lines as possible
(to simplify teaching these ideas as well as any further experimentation).
All the code for the above functionality comes in at just
under 300 lines of AI code (plus another 200 lines of  misc support routines). 
<p style="text-align: left;">
To read this, code:<br>
FIRST skim the <code>help</code> string (at top);  <br><br>SECOND browse the structs (see “<a href="#create">Creation</a>“);  <br> 
THIRD read  the <a href="#egs">examples</a> at end.  </p>
<p style="text-align: left;">
Note that any of the examples can be run from the command line; 
e.g. “-g show” runs
all the actions that start with “show”. 
Also, all the settings in the help string can
be changed on the command line; e.g. “lua fetchr.lua -s 3” sets the seed to 3.
Those settings are stored in”the” table, which is generated from
“help”. </p>
<p style="text-align: left;">
In the function arguments, the following conventions apply (usually):</p>

<ul>
<li>Two spaces denote start of optional args</li>
<li>Four spaces denote start of local args. </li>
<li>n == number</li>
<li>s == string</li>
<li>t == table</li>
<li>is == boolean</li>
<li>x == anything</li>
<li>fun == function</li>
<li>UPPER = class (some factory for making similar things)</li>
<li>lower = instance; e.g. sym is an instance of SYM</li>
<li>xs == a table of “x”; e.g. “ns” is a list of numbers</li>
</ul>
<p style="text-align: left;">
In this language (LUA) vars are global by default unless marked with “local” or 
defined in function argument lists.
Also,  there is only one data structure called a “table”.
that can have numeric or symbolic keys.
The tables start and end with {} and #t is length of a table
(and empty tables have #t==0).
Tables can have numeric or symbolic fields. Note that
<code>for pos,x in pairs(t) do</code> is the same as python’s 
<code>for pos,x in enumerate(t) do</code>.</p>

<p><a name=license></p>
<h2 id="bsd-2-clause-license">BSD 2-Clause License</h2>
<p><p style="text-align: left;">
Copyright (c) 2022, Tim Menzies
All rights reserved.</p>
<p><p style="text-align: left;">
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>
<p><p style="text-align: left;"></p>
<ol>
<li>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.<p style="text-align: left;"></li>
<li>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</li>
</ol>
<p><p style="text-align: left;">
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS”
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
